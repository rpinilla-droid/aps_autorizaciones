<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARS Servicios de Salud - Autorizaciones</title>
    <!-- Carga de Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Font Awesome para √≠conos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Configuraci√≥n base de la fuente */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
        }

        /* Estilos estructurales para el login y el cuerpo principal */
        .login-body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f8f9fa; /* bg-gray-100 */
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 500;
            color: var(--secondary-color);
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 700;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Estilos para la tabla de servicios y el contenedor responsive */
        .services-table-container {
            overflow-x: auto;
        }
        
        .services-table-container table {
            min-width: 800px;
        }
        
        /* Estilo para el men√∫ lateral, asegurando que se adapte al contenido en pantalla de forma vertical */
        #sidebar-menu {
             align-self: flex-start;
        }

        /* Ocultar las vistas iniciales */
        #main-app-view {
            display: none;
        }
        
        /* Estilos para la barra de estado dentro del formulario (no fija) */
        .status-bar-container {
            background-color: #f8f9fa; /* Color de fondo suave */
            border-top: 1px solid #e2e8f0; /* border-gray-200 */
            padding: 1rem;
            border-radius: 0 0 0.5rem 0.5rem;
            margin-top: 1rem;
        }
        
        /* Estilos para los campos deshabilitados en modo consulta */
        .form-input-display[disabled], .form-select-display[disabled] {
            background-color: #f3f4f6; /* gray-100 */
            border-color: #d1d5db; /* gray-300 */
            cursor: default;
        }
        /* Para que los inputs dentro de la tabla no sean editables en modo consulta */
        #form-view input[type="text"][disabled],
        #form-view input[type="number"][disabled],
        #form-view input[type="date"][disabled] {
            pointer-events: none;
            color: #4b5563; /* Text-gray-600 */
            background-color: transparent;
        }

    </style>
</head>
<body class="bg-gray-100">

    <!-- ---------------------------------------------------- -->
    <!-- -------------- VISTA DE INICIO DE SESI√ìN ----------- -->
    <!-- ---------------------------------------------------- -->
    <div id="login-view" class="login-body">
        <div class="w-full max-w-md p-6">
            <div class="bg-white p-8 rounded-xl shadow-xl text-center">
                <h1 class="text-3xl font-bold text-blue-600 mb-1">ARS Salud</h1>
                <p class="text-gray-500 mb-6">M√≥dulo de Servicios y Autorizaciones</p>
                
                <form id="login-form">
                    <div class="mb-4 text-left">
                        <label for="username" class="block text-sm font-semibold text-gray-700 mb-1">Usuario (Rol)</label>
                        <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: auditor, agente, supervisor" required>
                    </div>
                    <div class="mb-6 text-left">
                        <label for="password" class="block text-sm font-semibold text-gray-700 mb-1">Contrase√±a</label>
                        <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md">
                        <i class="fas fa-sign-in-alt mr-2"></i> Iniciar Sesi√≥n
                    </button>
                </form>

                <div id="login-message" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm" role="alert"></div>

                <div class="mt-4 text-sm">
                    <a href="#" class="text-blue-600 hover:text-blue-700">¬øOlvid√≥ su contrase√±a?</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ---------------------------------------------------- -->
    <!-- ---------------- VISTA DE APLICACI√ìN PRINCIPAL ----- -->
    <!-- ---------------------------------------------------- -->
    <div id="main-app-view">
        <header class="bg-blue-600 text-white shadow-md">
            <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-xl md:text-2xl font-bold mb-2 md:mb-0">M√≥dulo de Servicios de Salud</h1>
                
                <!-- Men√∫ de Usuario (Opciones propias del usuario) -->
                <div class="relative flex items-center">
                    <button id="user-menu-button" class="flex items-center space-x-2 p-2 rounded-full hover:bg-blue-500 transition duration-150">
                        <span class="font-semibold text-lg" id="header-username">USUARIO</span>
                        <i class="fas fa-user-circle text-2xl"></i>
                    </button>
                    
                    <!-- Dropdown del Men√∫ de Usuario -->
                    <div id="user-dropdown-menu" class="absolute right-0 top-full mt-2 w-56 bg-white text-gray-800 rounded-lg shadow-xl py-1 z-20 hidden">
                        <div class="px-4 py-2 text-sm text-gray-500 border-b mb-1 font-semibold" id="dropdown-username-info"></div>
                        <a href="#" id="change-password-btn" class="flex items-center px-4 py-2 text-sm hover:bg-gray-100 transition">
                            <i class="fas fa-key mr-2"></i> Cambiar Contrase√±a
                        </a>
                        <a href="#" id="logout-btn" class="flex items-center px-4 py-2 text-sm hover:bg-gray-100 transition border-t mt-1">
                            <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesi√≥n
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Contenedor principal con Sidebar y Contenido (responsive flex) -->
        <div class="container mx-auto px-4 py-5 flex flex-col md:flex-row gap-6">

            <!-- 1. SIDEBAR (Men√∫ de Tipos de Autorizaci√≥n) -->
            <nav id="sidebar-menu" class="w-full md:w-64 bg-white p-4 rounded-xl shadow-lg flex-shrink-0 h-fit">
                <h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2">Tipos de Autorizaci√≥n</h3>
                <div id="auth-type-menu" class="space-y-1">
                    <!-- Los botones del men√∫ se insertar√°n aqu√≠ por JS -->
                </div>
            </nav>

            <!-- 2. PANEL DE CONTENIDO PRINCIPAL -->
            <div id="main-content-panel" class="flex-grow pb-5">
                
                <!-- VISTA 1: SALPICADERO (Dashboard de Autorizaciones Listadas) -->
                <div id="dashboard-view" class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h2 class="text-xl font-bold text-gray-700" id="dashboard-title">Autorizaciones [TIPO SELECCIONADO]</h2>
                        <!-- Bot√≥n Adicionar/Crear - La disponibilidad depende del rol -->
                        <button id="add-new-btn" class="flex items-center bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-plus mr-2"></i> Adicionar
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Autorizaci√≥n #</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Afiliado</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prestador</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Apertura</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estatus</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="authorizations-list">
                                <!-- Filas de autorizaciones simuladas se insertar√°n aqu√≠ por JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- VISTA 2: FORMULARIO (Creaci√≥n / Edici√≥n) -->
                <div id="form-view" class="hidden">
                    <!-- Barra de Herramientas del Formulario (Modificar, Anular, Imprimir, Guardar, etc.) -->
                    <nav id="form-toolbar" class="bg-white p-4 rounded-lg shadow-lg mb-6 flex flex-wrap gap-3">
                        <!-- Modificar y Anular se OCULTAN en modo Adicionar -->
                        <button id="form-modificar-btn" class="flex items-center bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition disabled:opacity-50 disabled:cursor-not-allowed hidden"><i class="fas fa-edit mr-2"></i> Modificar</button>
                        <button id="form-anular-btn" class="flex items-center bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed hidden"><i class="fas fa-times mr-2"></i> Anular</button>
                        
                        <button id="form-imprimir-btn" class="flex items-center bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition hidden"><i class="fas fa-print mr-2"></i> Imprimir</button>
                        <span class="border-l mx-2 hidden" id="separator-casos"></span>
                        <button id="form-casos-btn" class="flex items-center bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-700 transition disabled:opacity-50 disabled:cursor-not-allowed"><i class="fas fa-folder-open mr-2"></i> Casos</button>
                        <button id="form-excepcion-btn" class="flex items-center bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 transition disabled:opacity-50 disabled:cursor-not-allowed"><i class="fas fa-certificate mr-2"></i> Excepci√≥n</button>
                        <!-- BOT√ìN GUARDAR (Solo visible y activo si se est√° en Modo Edici√≥n o Adicionar) -->
                        <button id="form-guardar-btn" class="flex items-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition disabled:opacity-50 disabled:cursor-not-allowed hidden"><i class="fas fa-save mr-2"></i> Guardar</button>
                        <button id="form-cancelar-btn" class="flex items-center bg-gray-400 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition"><i class="fas fa-undo mr-2"></i> Cancelar</button>
                    </nav>

                    <!-- Formulario de Autorizaci√≥n -->
                    <section class="bg-white p-6 rounded-lg shadow-lg mb-6">
                        <h2 class="text-xl font-bold mb-4 text-gray-700">Detalle de la Autorizaci√≥n #<span id="auth-number-display">[---]</span></h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            
                            <!-- Campos principales -->
                            <div class="space-y-4">
                                <label for="autorizacion-num" class="block text-sm font-semibold">Autorizaci√≥n #</label>
                                <input type="text" id="autorizacion-num" value="[Auto]" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 form-input-display">
                            </div>
                            <div class="space-y-4">
                                <label for="prestador" class="block text-sm font-semibold">Prestador</label>
                                <input type="text" id="prestador" placeholder="Seleccione Prestador" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-display">
                            </div>
                            <div class="space-y-4">
                                <label for="solicita" class="block text-sm font-semibold">Solicitado por</label>
                                <input type="text" id="solicita" placeholder="Nombre" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-display">
                            </div>
                            
                            <!-- Campos Afiliado / Tel√©fono / Tipo Servicio -->
                            <div class="space-y-4">
                                <label for="afiliado" class="block text-sm font-semibold">Afiliado</label>
                                <input type="text" id="afiliado" placeholder="ID/P√≥liza" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-display">
                            </div>
                            <div class="space-y-4">
                                <label for="telefono" class="block text-sm font-semibold">Tel√©fono</label>
                                <input type="tel" id="telefono" placeholder="N√∫mero de contacto" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-display">
                            </div>
                            <div class="space-y-4">
                                <label for="tipo-servicio" class="block text-sm font-semibold">Tipo Servicio</label>
                                <select id="tipo-servicio" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-select-display">
                                    <option>Ambulatorio</option>
                                    <option>Internamiento</option>
                                    <option>Prevenci√≥n</option>
                                </select>
                            </div>

                            <!-- Campos Origen / Tipo Atenci√≥n / Tipo Riesgo -->
                            <div class="space-y-4">
                                <label for="origen" class="block text-sm font-semibold">Origen Servicio</label>
                                <input type="text" id="origen" placeholder="C√≥digo" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-display">
                            </div>
                            <div class="space-y-4">
                                <label for="tipo-atencion" class="block text-sm font-semibold">Tipo Atenci√≥n</label>
                                <select id="tipo-atencion" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-select-display">
                                    <option>Programada</option>
                                    <option>Emergencia</option>
                                </select>
                            </div>
                            <div class="space-y-4">
                                <label for="tipo-riesgo" class="block text-sm font-semibold">Tipo Riesgo</label>
                                <input type="text" id="tipo-riesgo" placeholder="Seguro de Cobertura" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-display">
                            </div>
                            
                            <!-- Campos de Fecha y Dx. -->
                            <div class="space-y-4">
                                <label for="apertura" class="block text-sm font-semibold">Fecha Apertura</label>
                                <input type="date" id="apertura" value="2025-12-01" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-display">
                            </div>
                            <div class="space-y-4">
                                <label for="cierre" class="block text-sm font-semibold">Fecha Cierre</label>
                                <input type="date" id="cierre" placeholder="Auto-cierre para ambulatorio" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-display">
                            </div>
                            <div class="space-y-4">
                                <label for="dx-presuntivo" class="block text-sm font-semibold">Dx. Presuntivo (CIE-10)</label>
                                <input type="text" id="dx-presuntivo" placeholder="Buscar Diagn√≥stico" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-display">
                            </div>
                        </div>
                    </section>

                    <!-- Pesta√±as de Detalle y Alertas -->
                    <section class="bg-white p-6 rounded-lg shadow-lg mb-6">
                        <div class="flex border-b-2 border-gray-200 mb-4 flex-wrap gap-2" id="tab-header">
                            <button class="tab-btn active" data-tab="servicios">Servicios</button>
                            <button class="tab-btn" data-tab="diagnosticos">Diagn√≥sticos</button>
                            <button class="tab-btn" data-tab="restricciones">Restricciones/Alertas</button>
                            <button class="tab-btn" data-tab="afiliado">Datos Afiliado</button>
                        </div>
                        
                        <div id="servicios" class="tab-content active">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">Detalle de Servicios</h3>
                            <div class="services-table-container border rounded-lg">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-3 border-b text-left">Rengl√≥n</th>
                                            <th class="p-3 border-b text-left">Descripci√≥n del Servicio</th>
                                            <th class="p-3 border-b text-left">Cant.</th>
                                            <th class="p-3 border-b text-left">Precio</th>
                                            <th class="p-3 border-b text-left">Total</th>
                                            <th class="p-3 border-b text-left">% Cobertura</th>
                                            <th class="p-3 border-b text-left">Copago</th>
                                            <th class="p-3 border-b text-left">Fecha Servicio</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="hover:bg-gray-50">
                                            <td class="p-3 border-b"><input type="text" value="G-100" class="w-full"></td>
                                            <td class="p-3 border-b"><input type="text" value="Consulta de Medicina General" class="w-full"></td>
                                            <td class="p-3 border-b"><input type="number" value="1" class="w-full text-right"></td>
                                            <td class="p-3 border-b text-right">1500.00</td>
                                            <td class="p-3 border-b text-right font-medium">1500.00</td>
                                            <td class="p-3 border-b"><input type="number" value="80" class="w-full text-right"></td>
                                            <td class="p-3 border-b text-right font-medium text-red-600">300.00</td>
                                            <td class="p-3 border-b"><input type="date" value="2025-12-01" class="w-full"></td>
                                        </tr>
                                        <tr class="hover:bg-gray-50">
                                            <td class="p-3 border-b"><input type="text" value="S-205" class="w-full"></td>
                                            <td class="p-3 border-b"><input type="text" value="Laboratorio B√°sico" class="w-full"></td>
                                            <td class="p-3 border-b"><input type="number" value="1" class="w-full text-right"></td>
                                            <td class="p-3 border-b text-right">500.00</td>
                                            <td class="p-3 border-b text-right font-medium">500.00</td>
                                            <td class="p-3 border-b"><input type="number" value="100" class="w-full text-right"></td>
                                            <td class="p-3 border-b text-right font-medium text-red-600">0.00</td>
                                            <td class="p-3 border-b"><input type="date" value="2025-12-01" class="w-full"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="flex justify-end mt-3">
                                <button class="bg-blue-100 text-blue-600 font-semibold py-1.5 px-3 rounded-lg hover:bg-blue-200 text-xs"><i class="fas fa-plus mr-1"></i> A√±adir Servicio</button>
                            </div>
                            <div class="totals flex justify-end gap-6 mt-4 pt-4 border-t border-gray-200 text-lg font-bold">
                                <span class="text-gray-600">Total Cobertura: <span class="text-green-600">7,200.00</span></span>
                                <span class="text-gray-600">Total Copago: <span class="text-red-600">800.00</span></span>
                            </div>
                        </div>
                        
                        <div id="diagnosticos" class="tab-content">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">Diagn√≥sticos Secundarios y Condiciones</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="space-y-4">
                                    <label for="dx-sec1" class="block text-sm font-semibold">Dx. Secundario I (CIE-10)</label>
                                    <input type="text" id="dx-sec1" placeholder="Diagn√≥stico secundario" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-display">
                                </div>
                                <div class="space-y-4">
                                    <label for="dx-sec2" class="block text-sm font-semibold">Dx. Secundario II (CIE-10)</label>
                                    <input type="text" id="dx-sec2" placeholder="Diagn√≥stico secundario" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-display">
                                </div>
                                <div class="space-y-4">
                                    <label for="complicacion" class="block text-sm font-semibold">Complicaci√≥n (CIE-10)</label>
                                    <input type="text" id="complicacion" placeholder="Diagn√≥stico de complicaci√≥n" class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-display">
                                </div>
                            </div>
                        </div>

                        <div id="restricciones" class="tab-content">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">üì¢ Controles y Alertas Aplicadas</h3>
                            <div class="flex flex-col gap-4">
                                
                                <!-- Alerta por Afiliado/Servicio/Grupos -->
                                <div class="p-4 rounded-lg flex items-start space-x-3 bg-yellow-100 text-yellow-800 border border-yellow-300">
                                    <i class="fas fa-exclamation-triangle mt-1"></i>
                                    <div>
                                        <span class="font-bold">Alerta por Afiliado:</span> L√≠mite de 3 consultas de especialidad alcanzado para el mes.
                                    </div>
                                </div>
                                
                                <!-- Restricci√≥n con Opci√≥n de Excepci√≥n -->
                                <div class="p-4 rounded-lg flex items-start space-x-3 bg-red-100 text-red-800 border border-red-300 justify-between flex-wrap gap-2">
                                    <div class="flex items-start space-x-3">
                                        <i class="fas fa-ban mt-1"></i>
                                        <div>
                                            <span class="font-bold">Restricci√≥n por Servicio:</span> El servicio "Ecograf√≠a 3D" no est√° cubierto por el plan b√°sico del afiliado.
                                        </div>
                                    </div>
                                    <button class="bg-gray-500 text-white font-semibold py-1.5 px-3 rounded-lg hover:bg-gray-600 text-xs self-center">Crear Excepci√≥n</button>
                                </div>
                                
                                <!-- Notificaci√≥n de Auditor√≠a -->
                                <div class="p-4 rounded-lg flex items-start space-x-3 bg-blue-100 text-blue-800 border border-blue-300">
                                    <i class="fas fa-notes-medical mt-1"></i>
                                    <div>
                                        <span class="font-bold">Auditor√≠a Concurrente:</span> Esta autorizaci√≥n ha activado el m√≥dulo de auditor√≠a concurrente.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="afiliado" class="tab-content">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">Datos Generales del Afiliado y Planes</h3>
                            <p class="text-gray-600">Aqu√≠ se informa de los datos generales del afiliado en cuesti√≥n, as√≠ como la descripci√≥n y los periodos de vigencia de los planes contratados por el afiliado (B√°sico, Voluntario, Colectivo, etc.).</p>
                        </div>

                    </section>
                    
                    <!-- Barra de Estatus (Integrada al Formulario) -->
                    <div class="status-bar-container bg-gray-50 rounded-xl shadow-inner p-4 text-sm">
                        <div class="flex flex-wrap gap-5 justify-start items-center">
                            <span><span class="font-bold text-gray-700">Estatus:</span> <span id="status-text" class="font-bold text-green-400">Consultando</span></span>
                            <span><span class="font-bold text-gray-700">Usuario:</span> <span id="status-user" class="font-bold"></span></span>
                            <button class="flex items-center text-gray-600 hover:text-blue-600 transition" title="Ver Modificaciones"><i class="fas fa-exchange-alt mr-1"></i> Modificaciones: 2</button>
                            <button class="flex items-center text-gray-600 hover:text-blue-600 transition" title="Ver Notas"><i class="fas fa-comment-dots mr-1"></i> Notas: 1</button>
                            <button class="flex items-center text-gray-600 hover:text-blue-600 transition" title="Ver Digitalizaciones"><i class="fas fa-file-alt mr-1"></i> Digitalizaciones: 3</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuraci√≥n de Roles y Permisos ---
            // Tipos de acciones permitidas: C (Crear), R (Consultar), U (Actualizar), D (Anular)
            const ALL = ['telefonia', 'precertificacion', 'referidas', 'reembolso', 'webservice', 'reclamo', 'capitas'];

            const roles = {
                // Auditor: CRUD en todo.
                auditor: { permissions: ALL.map(type => ({ type, actions: ['C', 'R', 'U', 'D'] })) },
                
                // Agente: CRU solo en Telef√≥nica.
                agente: { permissions: [{ type: 'telefonia', actions: ['C', 'R', 'U'] }] },
                
                // Supervisor: CRUD en Telef√≥nica. R en el resto.
                supervisor: {
                    permissions: [
                        { type: 'telefonia', actions: ['C', 'R', 'U', 'D'] },
                        { type: 'precertificacion', actions: ['R'] },
                        { type: 'referidas', actions: ['R'] },
                        { type: 'reembolso', actions: ['R'] },
                        { type: 'webservice', actions: ['R'] },
                        { type: 'reclamo', actions: ['R'] },
                        { type: 'capitas', actions: ['R'] },
                    ]
                }
            };

            // Mapeo de tipos de autorizaci√≥n para el selector
            const optionsMap = {
                'telefonia': 'Autorizaciones Telef√≥nicas',
                'precertificacion': 'Autorizaciones Pre-Certificadas',
                'referidas': 'Autorizaciones Referidas',
                'reembolso': 'Autorizaciones de Reembolsos',
                'webservice': 'Autorizaciones Web Service',
                'reclamo': 'Reclamos No Autorizados',
                'capitas': 'Contratos por Capitas'
            };
            
            // Datos simulados de autorizaciones por tipo
            const mockAuthorizations = {
                'telefonia': [
                    { id: 'AUT-1001', afiliado: 'Juan P√©rez', prestador: 'Cl√≠nica Central', fecha: '2025-11-20', estatus: 'Pendiente' },
                    { id: 'AUT-1002', afiliado: 'Mar√≠a L√≥pez', prestador: 'Hospital del Sol', fecha: '2025-11-21', estatus: 'Cerrada' }
                ],
                'precertificacion': [
                    { id: 'PRE-500', afiliado: 'Carlos Ruiz', prestador: 'Centro de Cirug√≠a', fecha: '2025-11-15', estatus: 'Aprobada' },
                ],
                'referidas': [
                    { id: 'REF-001', afiliado: 'Luisa Pe√±a', prestador: 'Cl√≠nica General', fecha: '2025-11-18', estatus: 'Pendiente' },
                ],
                'reembolso': [
                    { id: 'REM-205', afiliado: 'Ana G√≥mez', prestador: 'Dr. Smith', fecha: '2025-11-25', estatus: 'Revisi√≥n' },
                ],
                'webservice': [
                    { id: 'WEB-404', afiliado: 'Javier Soto', prestador: 'Laboratorio', fecha: '2025-11-29', estatus: 'Abierta' },
                ],
                'reclamo': [
                    { id: 'REC-301', afiliado: 'Pedro Sanz', prestador: 'Servicios Externos', fecha: '2025-11-10', estatus: 'Reclamado' },
                ],
                'capitas': [
                    { id: 'CAP-150', afiliado: 'Elena D√≠az', prestador: 'Centro Preventivo', fecha: '2025-11-05', estatus: 'Cerrada' },
                ]
            };

            // --- Elementos de Vistas y Estados ---
            const loginView = document.getElementById('login-view');
            const mainAppView = document.getElementById('main-app-view');
            const dashboardView = document.getElementById('dashboard-view');
            const formView = document.getElementById('form-view');
            const authTypeMenu = document.getElementById('auth-type-menu');
            const formCancelarBtn = document.getElementById('form-cancelar-btn');
            const addNewBtn = document.getElementById('add-new-btn');
            const loginForm = document.getElementById('login-form'); 
            const loginMessage = document.getElementById('login-message');
            
            // Botones de la barra del formulario
            const formModificarBtn = document.getElementById('form-modificar-btn');
            const formAnularBtn = document.getElementById('form-anular-btn');
            const formImprimirBtn = document.getElementById('form-imprimir-btn');
            const formGuardarBtn = document.getElementById('form-guardar-btn');
            const separatorCasos = document.getElementById('separator-casos');
            
            // Campos de entrada y selecci√≥n
            const formInputs = document.querySelectorAll('.form-input-display');
            const formSelects = document.querySelectorAll('.form-select-display');
            
            let currentMode = 'dashboard'; // 'dashboard', 'consultar', 'adicionar', 'modificar'


            // --- Funciones de Permisos ---
            let userPermissionsMap = {}; // Mapeo { 'telefonia': ['C', 'R', 'U', 'D'], ... }

            const can = (type, action) => userPermissionsMap[type] && userPermissionsMap[type].includes(action);
            const getCurrentAuthType = () => document.querySelector('#auth-type-menu button.bg-blue-100')?.getAttribute('data-auth-type');
            
            // --- Control de Vistas y L√≥gica de Inicio ---
            
            // Funci√≥n para iniciar la vista de la aplicaci√≥n (se llama tras el login exitoso)
            function initializeApp() {
                const permissionsArray = JSON.parse(localStorage.getItem('userPermissions') || '[]');
                const loggedInUser = localStorage.getItem('loggedInUser'); // Obtener aqu√≠
                
                // Actualizar mapa de permisos
                userPermissionsMap = permissionsArray.reduce((acc, current) => {
                    acc[current.type] = current.actions;
                    return acc;
                }, {});

                // Configuraci√≥n de la cabecera (Header)
                const headerUsername = document.getElementById('header-username');
                const dropdownUsernameInfo = document.getElementById('dropdown-username-info');
                const statusUser = document.getElementById('status-user');
                
                headerUsername.textContent = loggedInUser;
                dropdownUsernameInfo.textContent = 'Rol: ' + loggedInUser;
                statusUser.textContent = loggedInUser; 
                
                // Configuraci√≥n del Men√∫ Lateral
                const availableTypes = permissionsArray.map(p => p.type);
                authTypeMenu.innerHTML = ''; // Limpiar men√∫
                
                availableTypes.forEach((permission, index) => {
                    const button = document.createElement('button');
                    button.classList.add('w-full', 'text-left', 'p-2', 'rounded-lg', 'transition', 'duration-150', 'text-gray-700', 'hover:bg-blue-50', 'hover:text-blue-600', 'font-semibold', 'text-sm');
                    button.textContent = optionsMap[permission] || permission;
                    button.setAttribute('data-auth-type', permission);
                    
                    if (index === 0) {
                        button.classList.add('bg-blue-100', 'text-blue-600');
                    }

                    button.addEventListener('click', (e) => {
                        document.querySelectorAll('#auth-type-menu button').forEach(btn => {
                            btn.classList.remove('bg-blue-100', 'text-blue-600');
                            btn.classList.add('text-gray-700');
                        });
                        button.classList.add('bg-blue-100', 'text-blue-600');
                        button.classList.remove('text-gray-700');
                        
                        showDashboard(permission);
                    });

                    authTypeMenu.appendChild(button);
                });
                
                // Mostrar vista de aplicaci√≥n y cargar dashboard inicial
                loginView.style.display = 'none';
                mainAppView.style.display = 'block';

                if (availableTypes.length > 0) {
                    showDashboard(availableTypes[0]);
                }
                
                // --- Manejo de Dropdown de Usuario (Inicializado aqu√≠) ---
                const userMenuButton = document.getElementById('user-menu-button');
                const userDropdownMenu = document.getElementById('user-dropdown-menu');

                userMenuButton.addEventListener('click', () => {
                    userDropdownMenu.classList.toggle('hidden');
                });

                document.addEventListener('click', (event) => {
                    if (userDropdownMenu && !userMenuButton.contains(event.target) && !userDropdownMenu.contains(event.target)) {
                        userDropdownMenu.classList.add('hidden');
                    }
                });

                document.getElementById('change-password-btn').addEventListener('click', (e) => {
                    e.preventDefault(); 
                    userDropdownMenu.classList.add('hidden');
                    alert('Funci√≥n de Cambiar Contrase√±a: Se abrir√° la ventana para actualizar su clave de acceso.');
                });

                document.getElementById('logout-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.clear();
                    // En lugar de reload, manipulamos la vista directamente:
                    loginView.style.display = 'flex';
                    mainAppView.style.display = 'none';
                    // Limpiamos los campos de login para el siguiente intento (opcional)
                    if (loginForm) {
                        loginForm.reset();
                        loginMessage.classList.add('hidden');
                    }
                });
            }


            // --- L√≥gica de Login ---
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const username = document.getElementById('username').value.toLowerCase();
                    const password = document.getElementById('password').value;
                    
                    if (password === '1234' && roles[username]) {
                        localStorage.setItem('userRole', username);
                        localStorage.setItem('userPermissions', JSON.stringify(roles[username].permissions));
                        localStorage.setItem('loggedInUser', username.toUpperCase()); 
                        
                        // Transici√≥n directa a la aplicaci√≥n sin reload
                        initializeApp();
                    } else {
                        loginMessage.textContent = 'Credenciales o rol no v√°lidos. Pruebe con "auditor", "agente", o "supervisor" y contrase√±a 1234.';
                        loginMessage.classList.remove('hidden');
                    }
                });
            }

            // --- L√≥gica de Vistas (showDashboard y setFormMode) ---
            function showDashboard(type) {
                currentMode = 'dashboard';
                dashboardView.classList.remove('hidden');
                formView.classList.add('hidden');
                document.getElementById('dashboard-title').textContent = `Autorizaciones: ${optionsMap[type] || type}`;
                
                // Control del bot√≥n Adicionar
                const canCreate = can(type, 'C');
                addNewBtn.disabled = !canCreate;
                addNewBtn.classList.toggle('opacity-50', !canCreate);
                addNewBtn.classList.toggle('cursor-not-allowed', !canCreate);

                loadAuthorizationsList(type);
            }

            function setFormMode(mode, id = null) {
                const type = getCurrentAuthType();
                if (!type) return; 

                if (mode === 'adicionar' && !can(type, 'C')) {
                    alert('Permiso denegado: No tiene autorizaci√≥n para crear este tipo de registro.');
                    return;
                }
                
                dashboardView.classList.add('hidden');
                formView.classList.remove('hidden');
                currentMode = mode;
                
                const isNew = mode === 'adicionar';
                const isConsult = mode === 'consultar';
                const isModify = mode === 'modificar';
                
                document.getElementById('auth-number-display').textContent = isNew ? '[NUEVA - ' + (optionsMap[type] || type).toUpperCase() + ']' : id;
                
                const canUpdate = can(type, 'U');
                const canDelete = can(type, 'D');

                // 1. Control de Habilitaci√≥n de Campos: Habilitados si es Adicionar O Modificar
                const fieldsEnabled = isNew || isModify;
                formInputs.forEach(input => input.disabled = !fieldsEnabled);
                formSelects.forEach(select => select.disabled = !fieldsEnabled);

                // 2. Control de la Barra de Herramientas del Formulario
                
                // MOSTRAR/OCULTAR GUARDAR: Visible si es Adicionar O Modificar
                formGuardarBtn.classList.toggle('hidden', !(isNew || isModify));
                
                // OCULTAR MODIFICAR/ANULAR/IMPRIMIR en modo Adicionar
                formModificarBtn.classList.toggle('hidden', isNew);
                formAnularBtn.classList.toggle('hidden', isNew);
                formImprimirBtn.classList.toggle('hidden', isNew); // <--- CORRECCI√ìN PARA OCULTAR IMPRIMIR
                
                // Habilitar/Deshabilitar Modificar, Anular
                // Modificar/Anular solo habilitado si est√° en modo consultar Y tiene el permiso
                formModificarBtn.disabled = !(isConsult && canUpdate); 
                formAnularBtn.disabled = !(isConsult && canDelete);
                
                // Botones de flujo (Casos, Excepciones) solo si est√° en modo Adicionar O Modificar
                const disableFlowButtons = !(isNew || isModify);
                document.getElementById('form-casos-btn').disabled = disableFlowButtons;
                document.getElementById('form-excepcion-btn').disabled = disableFlowButtons;
                
                // 3. Actualizar barra de estado
                updateStatusBar();
                
                // Aplicar estilos de deshabilitado
                document.querySelectorAll('#form-toolbar button').forEach(btn => {
                    if (btn.id !== 'form-cancelar-btn' && btn.id !== 'form-guardar-btn' && btn.id !== 'form-imprimir-btn') {
                        btn.classList.toggle('opacity-50', btn.disabled);
                        btn.classList.toggle('cursor-not-allowed', btn.disabled);
                    }
                });
            }

            function updateStatusBar() {
                const type = getCurrentAuthType();
                const statusText = document.getElementById('status-text');
                statusText.classList.remove('text-green-400', 'text-red-400', 'text-yellow-400', 'text-gray-400');
                
                const canUpdate = can(type, 'U');

                if (currentMode === 'adicionar') {
                     statusText.textContent = 'Adicionando Nueva';
                     statusText.classList.add('text-green-400');
                } else if (currentMode === 'modificar') {
                    statusText.textContent = 'Modo Edici√≥n';
                    statusText.classList.add('text-red-400');
                } else if (currentMode === 'consultar') {
                    statusText.textContent = canUpdate ? 'Leyendo (Modificable)' : 'Solo Lectura';
                    statusText.classList.add(canUpdate ? 'text-yellow-400' : 'text-gray-400');
                } else {
                     statusText.textContent = 'Consultando';
                }
            }


            // --- L√≥gica de Listado ---
            function loadAuthorizationsList(type) {
                const listBody = document.getElementById('authorizations-list');
                listBody.innerHTML = '';
                
                const currentAuths = mockAuthorizations[type] || [];
                const canRead = can(type, 'R');
                
                if (!canRead) {
                    listBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500 font-bold">Permiso denegado: No tiene permisos para consultar este tipo de autorizaci√≥n.</td></tr>`;
                    return;
                }
                
                if (currentAuths.length === 0) {
                    listBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">No hay autorizaciones de tipo '${optionsMap[type]}' registradas.</td></tr>`;
                    return;
                }

                currentAuths.forEach(auth => {
                    const row = listBody.insertRow();
                    row.classList.add('hover:bg-blue-50');
                    
                    // Acci√≥n principal: Ver Detalle (consultar)
                    const actionButton = `<button onclick="handleAction('consultar', '${auth.id}')" class="text-blue-600 hover:text-blue-800 transition" title="Ver Detalle"><i class="fas fa-eye"></i> Ver</button>`;

                    const actionsHtml = `
                        <div class="flex space-x-2 justify-center">
                            ${actionButton}
                        </div>
                    `;

                    row.insertCell().textContent = auth.id;
                    row.insertCell().textContent = auth.afiliado;
                    row.insertCell().textContent = auth.prestador;
                    row.insertCell().textContent = auth.fecha;
                    row.insertCell().innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${auth.estatus === 'Pendiente' ? 'bg-yellow-100 text-yellow-800' : auth.estatus === 'Cerrada' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${auth.estatus}</span>`;
                    row.insertCell().innerHTML = actionsHtml;
                    row.cells[row.cells.length - 1].classList.add('text-center', 'whitespace-nowrap');
                });
            }
            
            // --- L√≥gica de Botones y Acciones Globales ---
            window.handleAction = (action, id) => {
                const authType = getCurrentAuthType();
                if (!authType) return;
                
                if (action === 'consultar') {
                    setFormMode('consultar', id);
                } else if (action === 'modificar') {
                    if (can(authType, 'U')) {
                        setFormMode('modificar', id);
                    } else {
                         alert('Permiso denegado: No tiene autorizaci√≥n para modificar este registro.');
                    }
                } else if (action === 'anular') {
                    if (can(authType, 'D')) {
                        if (confirm(`¬øConfirma que desea ANULAR la autorizaci√≥n ${id} (${optionsMap[authType]})?`)) {
                            alert(`Autorizaci√≥n ${id} anulada (simulado).`);
                            showDashboard(authType);
                        }
                    } else {
                        alert('Permiso denegado: No tiene autorizaci√≥n para anular este registro.');
                    }
                } else if (action === 'imprimir') {
                    alert(`Imprimiendo la autorizaci√≥n ${id}.`);
                }
            };
            
            // --- Eventos de Botones de la App (se mantienen) ---
            if (formCancelarBtn) {
                formCancelarBtn.addEventListener('click', () => {
                    const currentType = getCurrentAuthType();
                    if(currentType) showDashboard(currentType);
                });
            }

            if (formModificarBtn) {
                formModificarBtn.addEventListener('click', () => {
                    // Al presionar Modificar, cambia el modo a 'modificar' para habilitar campos y mostrar Guardar
                    const id = document.getElementById('auth-number-display').textContent.replace(/\[.*\]/g, '').trim();
                    handleAction('modificar', id);
                });
            }

            if (addNewBtn) {
                addNewBtn.addEventListener('click', () => {
                    setFormMode('adicionar');
                });
            }
            
            if (formGuardarBtn) {
                formGuardarBtn.addEventListener('click', () => {
                    alert('Autorizaci√≥n Guardada/Actualizada (simulado).');
                    const currentType = getCurrentAuthType();
                    if(currentType) showDashboard(currentType);
                });
            }

            if (document.getElementById('form-casos-btn')) {
                document.getElementById('form-casos-btn').addEventListener('click', () => {
                    alert('Abriendo ventana para crear/asignar Caso.');
                });
            }

            if (document.getElementById('form-excepcion-btn')) {
                document.getElementById('form-excepcion-btn').addEventListener('click', () => {
                    alert('Abriendo ventana para crear Excepci√≥n.');
                });
            }
            
            if (formImprimirBtn) {
                formImprimirBtn.addEventListener('click', () => {
                    const id = document.getElementById('auth-number-display').textContent.replace(/\[.*\]/g, '').trim();
                    handleAction('imprimir', id);
                });
            }


            // --- Carga Inicial ---
            const loggedInUserCheck = localStorage.getItem('loggedInUser');

            if (loggedInUserCheck) {
                // Si ya hay un usuario logueado en localStorage, inicializar la app.
                initializeApp();
            }
        });
    </script>
</body>
</html>
